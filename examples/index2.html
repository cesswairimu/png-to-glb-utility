<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>png-image-to-glb-formated-file-gen</title>

		<script src="https://cdn.jsdelivr.net/npm/gltf-js-utils/dist/gltfjsutils.js"></script>
		<script src="../node_modules/jquery/dist/jquery.min.js"></script>
		<script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">

		<link rel="stylesheet" href="main.css">
	</head>
	<body>
		<div class="container center">
			<h3>(Sample-2) PNG image to glb-formated file Generator</h3>
			<br>
			<div class="row">
				<div class="mb-3">
					<label for="formFile" class="form-label" id="img-preview">Default file input example</label>
					<input class="form-control" type="file" id="formFile" accept="image/*">
					<br>
				 <div class="invisible" id="convert-btn">
					 <button type="button" class="btn btn-secondary">Convert to glb</button>
				 </div>
				 <img class="" id="test-image" height="300" width="350" src="test.png">
				 <img id="uploaded-image" height="300" width="350">
				</div>
			</div>

		
		</div>
		
	
		<script>
			//-----select image code 

			const choseFile =  document.getElementById("formFile");
			const imgPreview = document.getElementById("img-preview");
			let convertBtn = document.getElementById("convert-btn");
			let uploadedSpace =  document.getElementById("uploaded-image");
			let img = document.getElementById("test-image");
			let uploadImg;
			

			choseFile.addEventListener("change", function() {
				getImgData();
			})

			function getImgData() {
				const files = choseFile.files[0];
				if (files) {
					const fileReader = new FileReader();
					fileReader.readAsDataURL(files);
					fileReader.addEventListener("load", function(){
						imgPreview.style.display = "block";
						imgPreview.innerHTML = '<img"' + this.result +'" />';
						uploadImg = this.result;
						let url = URL.createObjectURL(files);
						uploadedSpace.src = url;
						convertBtn.classList.remove('invisible');
										});
				}

			
			}



			//---------end of image upload



			convertBtn.addEventListener("click", function(){
				createGLFTAsset();

			});

			let gltfFiles;
		
			let glbFiles;
			
			// -------creating a GLFT Asset
			async function createGLFTAsset(){

			  let asset = new  GLTFUtils.GLTFAsset({"number": 0, "index": 0});
				let scene = new GLTFUtils.Scene("");
				asset.addScene(scene);



				// create a node
				let node = new GLTFUtils.Node();
				node.setTranslation(0.1, 0.2, -3);
				node.setRotationDegrees(20, 30, -40);
				node.setScale(0.8, 0.8, 0.8);
	
				scene.addNode(node);
				// console.log(scene);

				
				const  vertices = [-0.5, 0.0, 0.0, 0.5, 0.0, 0.0, -0.5, 0.5, 0.0, 0.5, 0.5, 0.0, -0.5, 1.0, 0.0, 0.5, 1.0, 0.0, -0.5, 1.5, 0.0, 0.5, 1.5, 0.0, -0.5, 2.0, 0.0, 0.5, 2.0, 0.0];
			
				let vertex_hash = [];
for (let i = 0; i < vertices.length; i += 3) {
  const vertex = new GLTFUtils.Vertex();
  vertex.x = vertices[i];
  vertex.y = [i + 1];
  vertex.z = vertices[i + 2];
  vertex_hash.push(vertex);
}
// console.log("vertex-hash------");
// console.log(vertex_hash);

 var triangles = [0, 1, 3, 0, 3, 2, 2, 3, 5, 2, 5, 4, 4, 5, 7, 4, 7, 6, 6, 7, 9, 6, 9, 8];

const mesh = new GLTFUtils.Mesh();
const material = new GLTFUtils.Material();
// console.log('image uploaded ----' +uploadImg);
const texture = new GLTFUtils.Texture(uploadedSpace);
//mesh.material = [new GLTFUtils.Material()];
texture.wrapS = GLTFUtils.WrappingMode.CLAMP_TO_EDGE;
texture.wrapT = GLTFUtils.WrappingMode.REPEAT;
material.pbrMetallicRoughness.baseColorTexture = texture;
material.doubleSided = true;
material.texture = texture;
mesh.material = [material];
for (let i = 0; i < triangles.length; i += 3) {
   v1 = vertex_hash[triangles[i]];
   v2 = vertex_hash[triangles[i + 1]];
   v3 = vertex_hash[triangles[i + 2]];
  mesh.addFace(v1, v2, v3, {r: 1, g: 1, b: 1}, 0);
}
node.mesh = mesh;








				
				glbFiles = downloadGlb(asset);
			


		



				console.log(asset);
			

				gltfFiles = downloadGltf(asset);

glbFiles.then(function(result){
				
				// plain file txt
				const arrBuffer = result;
const blo = new Blob([arrBuffer], { type: 'application/octet-stream' });

const ann = document.createElement('a');
ann.href = URL.createObjectURL(blo);
ann.download = 'cess.glb';
ann.click();
				})

				gltfFiles.then(function(result){
					console.log("result------");
					console.log(result['model.gltf'])

				// plain glb file download
				var element = document.createElement('a');
				element.setAttribute('href', 'data:text/plain;charset=utf-8,' + 
					result['model.gltf']);
				element.setAttribute('download', "test.gltf");
				element.style.display = 'none';
				document.body.appendChild(element);
				element.click();
				document.body.removeChild(element);	
				})				

			}
			
			//---------------end of GLFT section

			async function downloadGltf(asset){
				let files =   await GLTFUtils.exportGLTF(asset, {
					bufferOutputType: GLTFUtils.BufferOutputType.DataURI,
					imageOutputType: GLTFUtils.BufferOutputType.DataURI});
				return files;

			}

			async function downloadGlb(asset){
			let files = await GLTFUtils.exportGLB(asset);
			return files;
			}


		

		</script>


</body>
</html>
